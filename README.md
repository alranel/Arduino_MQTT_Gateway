<img src="https://content.arduino.cc/website/Arduino_logo_teal.svg" height="100" align="right" />

# Arduino_MQTT_Gateway ‚úâÔ∏è

[![License](https://img.shields.io/github/license/alranel/Arduino_MQTT_Gateway)](https://support.arduino.cc/hc/en-us/articles/360018434279-I-have-used-Arduino-for-my-project-do-I-need-to-release-my-source-code-)

This library implements a generic gateway between [Arduino Cloud](https://cloud.arduino.cc/) and any number of MQTT devices. It enables the following scenarios:

* **bidirectional sync** of properties between third-party devices (supporting MQTT natively or through **Tasmota**) and Arduino Cloud;
* **remote control** of local MQTT devices from an Arduino Cloud [dashboard](https://docs.arduino.cc/arduino-cloud/getting-started/dashboard-widgets) and the **Arduino mobile app**, as well as data collection and visualization;
* **local automations** (business logic) allowing devices to talk to each other locally without relying on a remote cloud;
* **communication between MQTT devices and other Arduino devices** thanks to the [automagic variable synchronization](https://docs.arduino.cc/arduino-cloud/features/device-to-device) feature provided by Arduino Cloud.

This library runs on an ESP32 board, which means it's the ideal solution for a home automation hub because:
* it does not require a single-board computer like a Raspberry Pi to run software like Home Assistant or similar;
* it consumes much less power than a single-board computer;
* it does not require a Linux operating system which means it is more secure because of simpler software stack, reduced attack surface and minimal need for security updates.

> **Warning**
> This is still a bit experimental, but works. Testing and feedback are much appreciated!

## Getting started

> **Note**
> This library is not in the Arduino library registry yet, so for now you'll need to install it locally with:
> 
> ```
> arduino-cli lib install --git-url https://github.com/alranel/Arduino_MQTT_Gateway.git`
> ```
> 
> and compile/upload the sketch using the Arduino IDE instead of using the IoT Cloud web interface (just click the "Open in Full Editor" button and then use the download command).

Using this gateway is pretty simple:

1. [Create a device and a thing](https://support.arduino.cc/hc/en-us/articles/360016495559-Add-and-connect-a-device-to-IoT-Cloud) on Arduino IoT Cloud. Call them something like "My_MQTT_Gateway".
2. Create as many cloud variables as you want to manage through this gateway. They'll belong all to this single thing you just created, representing the gateway and all the devices connected to it.
3. Make these modifications to the pre-generated sketch you'll get:
    * Add `#include <Arduino_MQTT_Gateway.h>` to the top.
    * Add as many calls to `ArduinoMQTTGateway.add()` as you need to configure the various variables you want to have synced.
    * Add `ArduinoMQTTGateway.loop()` in the `loop()` function.
4. Configure your MQTT devices to connect to the IP address of this broker (default port is 1883).

Example:

```c++
#include "arduino_secrets.h"
#include "thingProperties.h"
#include "Arduino_MQTT_Gateway.h"   // <--- add this

void setup() {
  /* This is the standard boilerplate generated by Arduino Cloud */
  Serial.begin(9600);
  delay(1500); 
  initProperties();
  ArduinoCloud.begin(ArduinoIoTPreferredConnection);
  setDebugMessageLevel(2);
  ArduinoCloud.printDebugInfo();

  /* 
    Now we'll configure a Shelly Plug S device. We want to:
    1) control its relay (on/off) remotely from Arduino Cloud;
    2) have its status reflected in Arduino Cloud in case the physical
       button is pressed;
    3) collect its power measurement and temperature data in the cloud.
  */

  // Shelly Plug S - relay
  ArduinoMQTTGateway.add(shelly02_relay)
    .setStateTopic("shellies/shellyplug-s-4022D889B588/relay/0")
    .setCommandTopic("shellies/shellyplug-s-4022D889B588/relay/0/command")
    .setStatePayload("on", "off")
    .setCommandPayload("on", "off");

  // Shelly Plug S - active power measurement
  ArduinoMQTTGateway.add(shelly02_power)
    .setStateTopic("shellies/shellyplug-s-4022D889B588/relay/0/power");

  // Shelly Plug S - temperature
  ArduinoMQTTGateway.add(shelly02_temperature)
    .setStateTopic("shellies/shellyplug-s-4022D889B588/temperature");
}

void loop() {
  ArduinoCloud.update();
  ArduinoMQTTGateway.loop();   // <--- add this
}
```

See more examples in the [examples/](examples/) directory, also showing how to handle JSON payloads.

To troubleshoot, it is recommended to connect the gateway to your PC and watch the serial monitor to see the incoming MQTT messages and their topics/payloads.

### Automations

By configuring local automations you'll make sure communication between your devices does not depend on network connectivity or an external cloud, as everything will happen in your local network.
The procedure is very straightforward, as you can just write them in the `loop()` function using normal Arduino syntax:

```c++
void loop() {
  ArduinoCloud.update();
  ArduinoMQTTGateway.loop();

  // Toggle a relay (like a Shelly Plug S) based on a sensor reading the status 
  // of a physical switch (like a Shelly i3)
  shellyplug_relay = shellyi3_input0;

  // Overcurrent protection
  if (shellyplug_power > 2000) {
    shellyplug_relay = false;
  }
}
```

Wait, that simple? Yes.

## Credits

This library includes code from the [TinyMqtt](https://github.com/hsaturn/TinyMqtt) Arduino library. Unfortunately, its `MqttClient` class conflicts with the homonymous class imported by `ArduinoIoTCloud` so for now we're shipping a renamed fork.

## üîé Resources

* [How to install a library](https://www.arduino.cc/en/guide/libraries)
* [Help Center](https://support.arduino.cc/)
* [Forum](https://forum.arduino.cc)

## üêõ Bugs & Issues

If you want to report an issue with this library, you can submit it to the [issue tracker](issues) of this repository. Remember to include as much detail as you can about your hardware set-up, code and steps for reproducing the issue. Make sure you're using an original Arduino board.

## üë®‚Äçüíª Development

There are many ways to contribute:

* Improve documentation and examples
* Fix a bug
* Test open Pull Requests
* Implement a new feature
* Discuss potential ways to improve this library

You can submit your patches directly to this repository as Pull Requests. Please provide a detailed description of the problem you're trying to solve and make sure you test on real hardware.

## üíõ Donations

This open-source code is maintained by Arduino with the help of the community. We invest a considerable amount of time in testing code, optimizing it and introducing new features. Please consider [donating](https://www.arduino.cc/en/donate/) or [sponsoring](https://github.com/sponsors/arduino) to support our work, as well as [buying original Arduino boards](https://store.arduino.cc/) which is the best way to make sure our effort can continue in the long term.